<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Random Card Animation</title>
<style>
  body {
    margin: 0;
    background: #111;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    overflow: hidden;
  }
  canvas {
    background: #1a1a2e;
  }
</style>
</head>
<body>

<canvas id="canvas" width="800" height="600"></canvas>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const cards = ["A","B","C","D","E"];

let spinning = false;
let stopRequested = false;
let ultraSlow = false;

let currentCard = cards[Math.floor(Math.random()*cards.length)];
let finalCard = null;

let angle = 0;
let spinSpeed = 0.5;

let stopTime = 0;
const ultraSlowDuration = 300;

let yOffset = 0;
let velocity = 0;
const gravity = 0.8;
let bouncing = false;

function randomColor(){
  return `rgb(${80+Math.random()*175},
              ${80+Math.random()*175},
              ${80+Math.random()*175})`;
}

document.addEventListener("keydown", e => {

  if(e.code === "Space" && !spinning){
    spinning = true;
    stopRequested = false;
    spinSpeed = 0.5;
  }

  if(e.code === "Enter" && spinning){
    stopRequested = true;
    stopTime = performance.now();
  }
});

function draw(){

  ctx.clearRect(0,0,canvas.width,canvas.height);

  // ===== ÂõûËª¢Âá¶ÁêÜ =====
  if(spinning){

    if(stopRequested){
      let elapsed = performance.now() - stopTime;

      if(elapsed < ultraSlowDuration){
        spinSpeed = 0.05; // Ë∂Ö„Çπ„É≠„Éº
      } else {
        spinning = false;
        finalCard = cards[Math.floor(Math.random()*cards.length)];
        currentCard = finalCard;

        // „Ç∏„É£„É≥„ÉóÈñãÂßã
        bouncing = true;
        velocity = -18;
      }
    } else {
      currentCard = cards[Math.floor(Math.random()*cards.length)];
    }

    angle += spinSpeed;
  }

  // ===== „Éê„Ç¶„É≥„ÉâÂá¶ÁêÜ =====
  if(bouncing){
    velocity += gravity;
    yOffset += velocity;

    if(yOffset > 0){
      yOffset = 0;
      velocity *= -0.6;
      if(Math.abs(velocity) < 2){
        bouncing = false;
      }
    }
  }

  // ===== ÊñáÂ≠óÊèèÁîª =====
  ctx.save();
  ctx.translate(canvas.width/2, canvas.height/2 + yOffset);
  ctx.rotate(angle);
  ctx.fillStyle = randomColor();
  ctx.font = "bold 120px sans-serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText(currentCard, 0, 0);
  ctx.restore();

  // ===== „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥„É™„É≥„Ç∞ÔºàËµ§Âõ∫ÂÆöÔºâ=====
  if(spinning && stopRequested){
    let progress = Math.min(
      (performance.now() - stopTime) / ultraSlowDuration,
      1
    );

    let radius = 150;
    let startAngle = -Math.PI/2;
    let endAngle = startAngle + progress * Math.PI * 2;

    ctx.beginPath();
    ctx.strokeStyle = "red";   // üî¥ Ëµ§Âõ∫ÂÆö
    ctx.lineWidth = 12;
    ctx.arc(canvas.width/2, canvas.height/2, radius,
            startAngle, endAngle);
    ctx.stroke();
  }

  requestAnimationFrame(draw);
}

draw();
</script>

</body>
</html>
