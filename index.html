import pygame
import random
import math
import sys

# =============================
# 初期設定
# =============================
pygame.init()
WIDTH, HEIGHT = 800, 600
screen = pygame.display.set_mode((WIDTH, HEIGHT))
pygame.display.set_caption("Random Card Animation")

clock = pygame.time.Clock()
font = pygame.font.SysFont(None, 120)

RED = (255, 0, 0)

cards = ["A", "B", "C", "D", "E"]

# =============================
# 状態管理
# =============================
running = True
spinning = False
stop_requested = False
ultra_slow = False

current_card = random.choice(cards)
final_card = None

spin_speed = 40
angle = 0

spin_start_time = 0
stop_time = 0
ultra_slow_duration = 300  # 0.3秒

# ジャンプ・バウンド用
jump_velocity = 0
y_offset = 0
gravity = 0.8
bounce_power = -18
bouncing = False

# =============================
# SEフック（必要なら実装）
# =============================
def play_decision_sound():
    pass


# =============================
# ランダム文字色
# =============================
def random_color():
    return (
        random.randint(80, 255),
        random.randint(80, 255),
        random.randint(80, 255),
    )


# =============================
# メインループ
# =============================
while running:
    dt = clock.tick(60)
    screen.fill((20, 20, 30))

    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False

        if event.type == pygame.KEYDOWN:
            if event.key == pygame.K_SPACE and not spinning:
                # スタート
                spinning = True
                stop_requested = False
                ultra_slow = False
                spin_start_time = pygame.time.get_ticks()
                spin_speed = 40

            elif event.key == pygame.K_RETURN and spinning:
                # 停止リクエスト
                stop_requested = True
                stop_time = pygame.time.get_ticks()

    # =============================
    # 回転処理
    # =============================
    if spinning:

        if stop_requested:
            elapsed = pygame.time.get_ticks() - stop_time

            if elapsed < ultra_slow_duration:
                ultra_slow = True
                spin_speed = 5
            else:
                # 停止
                spinning = False
                final_card = random.choice(cards)
                current_card = final_card
                bouncing = True
                jump_velocity = bounce_power
                play_decision_sound()

        else:
            # 通常高速
            spin_speed = 40
            current_card = random.choice(cards)

        angle += spin_speed

    # =============================
    # バウンド処理
    # =============================
    if bouncing:
        jump_velocity += gravity
        y_offset += jump_velocity

        if y_offset > 0:
            y_offset = 0
            jump_velocity *= -0.6
            if abs(jump_velocity) < 2:
                bouncing = False
                y_offset = 0

    # =============================
    # 文字描画
    # =============================
    color = random_color()
    text_surface = font.render(current_card, True, color)
    rotated = pygame.transform.rotate(text_surface, angle)
    rect = rotated.get_rect(center=(WIDTH // 2, HEIGHT // 2 + y_offset))
    screen.blit(rotated, rect)

    # =============================
    # 赤固定カウントダウンリング
    # =============================
    if spinning and stop_requested:
        progress = min(
            (pygame.time.get_ticks() - stop_time) / ultra_slow_duration,
            1
        )
        radius = 150
        thickness = 12
        end_angle = progress * 360

        pygame.draw.arc(
            screen,
            RED,
            (
                WIDTH // 2 - radius,
                HEIGHT // 2 - radius,
                radius * 2,
                radius * 2
            ),
            -math.pi / 2,
            -math.pi / 2 + math.radians(end_angle),
            thickness
        )

    pygame.display.flip()

pygame.quit()
sys.exit()
